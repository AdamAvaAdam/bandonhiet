<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng C·ªông h∆∞·ªüng V6.5 - D≈©ng Nguy·ªÖn</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; display: flex; height: 100vh; background: #1e272e; }
        #sidebar { width: 380px; padding: 15px; background: #1e272e; color: #ecf0f1; overflow-y: auto; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        #map { flex-grow: 1; cursor: crosshair; }
        .section { background: #2d3436; border-radius: 8px; margin-bottom: 12px; border: 1px solid #485460; }
        .section-header { background: #34495e; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; }
        .section-content { padding: 12px; }
        input, select { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: none; background: #ecf0f1; color: #2d3436; font-size: 16px; }
        button { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; background: #e67e22; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 16px; }
        #zoom-info { position: absolute; bottom: 20px; left: 400px; z-index: 1000; background: rgba(0,0,0,0.8); color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; pointer-events: none; border: 1px solid #e74c3c; }
        .stats-box { background: #34495e; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 5px solid #e74c3c; position: relative; }
        .btn-del-wh { background: #ff4757; padding: 5px 10px; font-size: 12px; width: auto; margin-top: 8px; cursor: pointer; border-radius: 4px; border:none; color:white; }
        .leaflet-heatmap-layer { pointer-events: none !important; z-index: 400 !important; }
        .dealer-tooltip { background: #2c3e50; color: #00d2d3; font-weight: bold; padding: 5px; border-radius: 4px; border: 1px solid #00d2d3; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color: #e74c3c; margin: 0 0 15px 0;">ƒêI·ªÄU PH·ªêI V6.5</h2>
    
    <div class="section">
        <div class="section-header" onclick="toggleSec(this)">1. ƒêi·ªÅu khi·ªÉn & T√¨m ki·∫øm <span>[‚àí]</span></div>
        <div class="section-content">
            <select id="heatToggle" onchange="toggleHeatLayer()">
                <option value="on">B·∫¨T C·ªông h∆∞·ªüng nhi·ªát</option>
                <option value="off">T·∫ÆT nhi·ªát</option>
            </select>
            <input type="text" id="areaSearchInput" placeholder="Vd: Qu·∫≠n Ho√†ng Mai, H√† N·ªôi" style="margin-top:15px;">
            <button onclick="searchArea()" style="background:#3498db;">üîç T√¨m & Bo vi·ªÅn</button>
            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:15px;">
                <span>C·∫Øm ƒëi·ªÉm ƒë·ªÅ xu·∫•t:</span>
                <select id="pinToggle" style="width:100px;"><option value="off">T·∫ÆT</option><option value="on">B·∫¨T</option></select>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-header" onclick="toggleSec(this)">2. D·ªØ li·ªáu ƒê·∫°i l√Ω <span>[‚àí]</span></div>
        <div class="section-content">
            <input type="file" id="excelFile" accept=".xlsx, .xls">
        </div>
    </div>

    <div id="warehouse-list"></div>
</div>

<div id="map"></div>
<div id="zoom-info">ƒê·ªô Zoom: <span id="zoom-level">12</span></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    const map = L.map('map', { tap: true, zoomSnap: 0.1 }).setView([21.02, 105.83], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    let dealers = [], warehouses = [];
    let highlightLayer = L.layerGroup().addTo(map);
    let heatLayerGroup = L.layerGroup().addTo(map);
    let dealerLayer = L.layerGroup().addTo(map);
    let heatLayer = null;

    function toggleSec(h) {
        const c = h.nextElementSibling;
        const s = h.querySelector('span');
        c.style.display = (c.style.display === "none") ? "block" : "none";
        s.innerText = (c.style.display === "none") ? "[+]" : "[‚àí]";
    }

    async function searchArea() {
        const input = document.getElementById('areaSearchInput').value;
        if (!input) return;
        const query = input + ", Vietnam";
        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&polygon_geojson=1&limit=1`);
            const data = await resp.json();
            if (data && data.length > 0) {
                highlightLayer.clearLayers();
                const geoLayer = L.geoJSON(data[0].geojson, { style: { color: "#3498db", weight: 3, fillOpacity: 0.15 }, interactive: false }).addTo(highlightLayer);
                map.fitBounds(geoLayer.getBounds(), { padding: [20, 20] });
            }
        } catch (e) { console.error(e); }
    }

    document.getElementById('excelFile').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(evt) {
            const workbook = XLSX.read(evt.target.result, {type:'binary'});
            const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
            dealers = []; dealerLayer.clearLayers();
            let heatPoints = [], maxSales = 0;
            
            for(let i = 1; i < data.length; i++) {
                const row = data[i]; if (!row || row.length < 5) continue;
                const ds = parseFloat(row[5]) || 0;
                if (ds > maxSales) maxSales = ds;
            }

            for(let i = 1; i < data.length; i++) {
                const row = data[i]; if (!row || row.length < 5) continue;
                const ds = parseFloat(row[5]) || 0;
                const lat = parseFloat(row[4]); const lng = parseFloat(row[3]);
                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.circleMarker([lat, lng], { color: '#2d3436', radius: 4, fillOpacity: 0.8, fillColor: '#2980b9', interactive: true }).addTo(dealerLayer);
                    marker.bindTooltip(`<b>${row[1]}</b><br>DS: ${ds.toLocaleString()}`, { sticky: true, className: 'dealer-tooltip' });
                    dealers.push({ latlng: L.latLng(lat, lng), ds: ds, name: row[1] });
                    if (ds > 0) {
                        // Tr·ªçng s·ªë intensity ƒë∆∞·ª£c ƒë·∫©y m·∫°nh h∆°n
                        let intensity = Math.pow(ds / maxSales, 0.7);
                        heatPoints.push([lat, lng, intensity]);
                    }
                }
            }
            if (heatLayer) heatLayerGroup.removeLayer(heatLayer);
            heatLayer = L.heatLayer(heatPoints, { 
                radius: 40, 
                blur: 20, 
                max: 1.0, 
                gradient: {0.4: 'blue', 0.6: 'cyan', 0.7: 'lime', 0.8: 'yellow', 1: 'red'} 
            }).addTo(heatLayerGroup);
            updateHeatEffect();
        };
        reader.readAsBinaryString(e.target.files[0]);
    });

    // LOGIC C·ªòNG H∆Ø·ªûNG SI√äU M·∫†NH CHO ZOOM 13-14
    function updateHeatEffect() {
        if (!heatLayer) return;
        const z = map.getZoom();
        document.getElementById('zoom-level').innerText = z.toFixed(1);
        
        let r, b;
        if (z >= 15) {
            r = 95; b = 40; // Soi ph·ªë c·ª±c ƒë·∫≠m
        } else if (z >= 13) {
            // ƒê·∫®Y M·∫†NH CHO T·∫¶M ZOOM 13-14
            r = 75; b = 25; 
        } else if (z >= 11) {
            r = 55; b = 20;
        } else {
            r = 60 + (11 - z) * 15;
            b = 25;
        }
        
        heatLayer.setOptions({ radius: r, blur: b });
    }
    map.on('zoomend', updateHeatEffect);

    function toggleHeatLayer() {
        if (!heatLayer) return;
        document.getElementById('heatToggle').value === 'on' ? heatLayerGroup.addLayer(heatLayer) : heatLayerGroup.removeLayer(heatLayer);
    }

    map.on('click', e => {
        if (document.getElementById('pinToggle').value !== 'on') return;
        const id = Date.now();
        const marker = L.marker(e.latlng, { draggable: true }).addTo(map);
        const circle = L.circle(e.latlng, { color: '#e74c3c', radius: 3000, fillOpacity: 0.1, interactive: false }).addTo(map);
        const wh = { id, marker, circle, latlng: e.latlng, name: "Kho " + (warehouses.length + 1) };
        
        marker.on('contextmenu', () => deleteWh(id));
        marker.on('drag', () => {
            wh.latlng = marker.getLatLng();
            circle.setLatLng(wh.latlng);
            updateAllStats();
        });
        warehouses.push(wh);
        updateAllStats();
    });

    function deleteWh(id) {
        const wh = warehouses.find(w => w.id === id);
        if (wh) {
            map.removeLayer(wh.marker);
            map.removeLayer(wh.circle);
            warehouses = warehouses.filter(w => w.id !== id);
            updateAllStats();
        }
    }

    function updateAllStats() {
        const div = document.getElementById('warehouse-list');
        div.innerHTML = '<strong style="display:block; margin:10px 0;">Kho ƒë·ªÅ xu·∫•t:</strong>';
        warehouses.forEach(w => {
            const inRange = dealers.filter(d => w.latlng.distanceTo(d.latlng) <= 3000);
            const sumSales = inRange.reduce((s, d) => s + d.ds, 0);
            div.innerHTML += `<div class="stats-box">
                <b>${w.name}</b><br>ƒê·∫°i l√Ω: ${inRange.length} | DS: <b style="color:#f1c40f">${sumSales.toLocaleString()}</b><br>
                <button class="btn-del-wh" onclick="deleteWh(${w.id})">X√≥a kho</button>
            </div>`;
        });
    }
</script>
</body>
</html>
