<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêi·ªÅu ph·ªëi Online V8.1 - D≈©ng Nguy·ªÖn</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; display: flex; height: 100vh; background: #1e272e; }
        #sidebar { width: 420px; padding: 15px; background: #1e272e; color: #ecf0f1; overflow-y: auto; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        #map { flex-grow: 1; cursor: crosshair; }
        .card { background: #2d3436; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #485460; }
        .card-title { font-weight: bold; color: #ff4757; margin-bottom: 10px; border-bottom: 1px solid #485460; padding-bottom: 8px; font-size: 14px; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 6px; border: none; background: #ecf0f1; color: #2d3436; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; font-size: 15px; }
        .btn-search { background: #3498db; color: white; }
        .btn-clear { background: #7f8c8d; color: white; margin-top: 5px; }
        .btn-refresh { background: #2ecc71; color: white; }
        #zoom-info { position: absolute; bottom: 20px; left: 440px; z-index: 1000; background: rgba(0,0,0,0.85); color: #f1c40f; padding: 8px 18px; border-radius: 20px; font-weight: bold; border: 2px solid #ff4757; pointer-events: none; }
        .stats-box { background: #34495e; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 5px solid #ff4757; }
        .dealer-list { display: none; margin-top: 10px; border-top: 1px solid #555; padding-top: 10px; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .dealer-row { display: grid; grid-template-columns: 1fr 85px 65px; gap: 8px; padding: 8px 0; border-bottom: 1px solid #444; align-items: center; }
        .dist-tag { color: #2ecc71; font-weight: bold; text-align: right; }
        .sales-tag { color: #f1c40f; text-align: right; font-weight: bold; }
        .leaflet-heatmap-layer, .leaflet-interactivePath { pointer-events: none !important; }
        .leaflet-marker-pane { z-index: 650 !important; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color: #ff4757; text-align: center; margin-bottom: 20px;">ƒêI·ªÄU PH·ªêI ONLINE V8.1</h2>

    <div class="card">
        <div class="card-title">üîÑ D·ªÆ LI·ªÜU TR·ª∞C TUY·∫æN</div>
        <button class="btn-refresh" onclick="loadDataOnline()">L√ÄM M·ªöI D·ªÆ LI·ªÜU</button>
        <p style="font-size: 11px; color: #bdc3c7; margin-top: 8px;">*D·ªØ li·ªáu ƒëang k·∫øt n·ªëi v·ªõi Google Sheets c·ªßa D≈©ng</p>
    </div>

    <div class="card">
        <div class="card-title">üîç T√åM KHU V·ª∞C</div>
        <input type="text" id="areaSearchInput" placeholder="Vd: Qu·∫≠n Ho√†ng Mai, H√† N·ªôi">
        <button class="btn-search" onclick="searchArea()">Xem ranh gi·ªõi</button>
        <button class="btn-clear" onclick="clearHighlight()">X√≥a vi·ªÅn</button>
    </div>

    <div class="card">
        <div class="card-title">üìç THI·∫æT L·∫¨P KHO</div>
        <div style="display:flex; align-items:center; justify-content:space-between;">
            <span>Ch·∫ø ƒë·ªô c·∫Øm ghim:</span>
            <select id="pinToggle" style="width:120px;"><option value="off">T·∫ÆT</option><option value="on">B·∫¨T</option></select>
        </div>
    </div>

    <div id="warehouse-list"></div>
</div>

<div id="map"></div>
<div id="zoom-info">ZOOM: <span id="zoom-level">12</span></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    const map = L.map('map', { tap: true, zoomSnap: 0.1 }).setView([21.02, 105.83], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    let dealers = [], warehouses = [];
    let highlightLayer = L.layerGroup().addTo(map);
    let heatLayerGroup = L.layerGroup().addTo(map);
    let dealerLayer = L.layerGroup().addTo(map);
    let heatLayer = null;

    async function loadDataOnline() {
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSqx48yei68qBJFSiHZzxCeGO0df4IDE6md9hzu7TUv5GjgOvU9yIpm4lEN6HJw9zJuek4YYMj8XAyn/pub?output=csv";
        
        try {
            const response = await fetch(sheetUrl);
            const csvText = await response.text();
            // T·ª± ƒë·ªông t√°ch d√≤ng b·∫±ng xu·ªëng d√≤ng, t√°ch c·ªôt b·∫±ng d·∫•u ph·∫©y ho·∫∑c tab
            const rows = csvText.split(/\r?\n/).slice(1);
            
            dealers = [];
            dealerLayer.clearLayers();
            let heatPoints = [];

            rows.forEach(rowStr => {
                const row = rowStr.split(/,|\t/); // Nh·∫≠n di·ªán c·∫£ ph·∫©y v√† tab
                if (row.length < 6) return;

                const ds = parseFloat(row[5].replace(/\./g, '').replace(/,/g, '')) || 0;
                const lat = parseFloat(row[4]);
                const lng = parseFloat(row[3]);

                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.circleMarker([lat, lng], { 
                        color: '#2d3436', radius: 5, fillOpacity: 0.8, 
                        fillColor: ds > 0 ? '#ff4757' : '#95a5a6', interactive: true 
                    }).addTo(dealerLayer);
                    
                    marker.bindTooltip(`<b>${row[1]}</b><br>DS: ${ds.toLocaleString()}`, { sticky: true });
                    dealers.push({ latlng: L.latLng(lat, lng), ds: ds, ten: row[1], ma: row[0] });

                    if (ds > 0) {
                        let intensity = 0.3 + (ds / 1000000000) * 0.7;
                        heatPoints.push([lat, lng, Math.min(intensity, 1.2)]);
                    }
                }
            });

            if (heatLayer) heatLayerGroup.removeLayer(heatLayer);
            heatLayer = L.heatLayer(heatPoints, { 
                radius: 95, blur: 35, max: 1.0, 
                gradient: { 0.2: '#ff9f43', 0.5: '#ff4757', 0.8: '#b33939', 1.0: '#5e0000' } 
            }).addTo(heatLayerGroup);
            updateHeatEffect();
        } catch (e) {
            alert("L·ªói k·∫øt n·ªëi Google Sheets. H√£y ki·ªÉm tra l·∫°i link!");
        }
    }

    window.onload = loadDataOnline;

    async function searchArea() {
        const input = document.getElementById('areaSearchInput').value;
        if (!input) return;
        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(input + ", Vietnam")}&format=json&polygon_geojson=1&limit=1`);
            const data = await resp.json();
            if (data && data.length > 0) {
                highlightLayer.clearLayers();
                const geo = L.geoJSON(data[0].geojson, { style: { color: "#3498db", weight: 4, fillOpacity: 0 }, interactive: false }).addTo(highlightLayer);
                map.fitBounds(geo.getBounds(), { padding: [20, 20] });
            }
        } catch (e) { console.error(e); }
    }

    function clearHighlight() { highlightLayer.clearLayers(); }

    function updateHeatEffect() {
        if (!heatLayer) return;
        const z = map.getZoom();
        document.getElementById('zoom-level').innerText = z.toFixed(1);
        let r = (z >= 13) ? 100 : (z >= 11 ? 75 : 60 + (11-z)*15);
        heatLayer.setOptions({ radius: r, blur: (z >= 13 ? 40 : 20) });
    }
    map.on('zoomend', updateHeatEffect);

    map.on('click', e => {
        if (document.getElementById('pinToggle').value !== 'on') return;
        const id = Date.now();
        const marker = L.marker(e.latlng, { draggable: true }).addTo(map);
        const circle = L.circle(e.latlng, { color: '#e74c3c', radius: 3000, fillOpacity: 0.1, interactive: false }).addTo(map);
        const wh = { id, marker, circle, latlng: e.latlng, name: "Kho " + (warehouses.length + 1) };
        marker.on('contextmenu', () => deleteWh(id));
        marker.on('dragend', () => { wh.latlng = marker.getLatLng(); circle.setLatLng(wh.latlng); updateAllStats(); });
        warehouses.push(wh); updateAllStats();
    });

    function deleteWh(id) {
        const wh = warehouses.find(w => w.id === id);
        if (wh) { map.removeLayer(wh.marker); map.removeLayer(wh.circle); warehouses = warehouses.filter(w => w.id !== id); updateAllStats(); }
    }

    async function toggleDealerList(id) {
        const listDiv = document.getElementById(`list-${id}`);
        listDiv.style.display = (listDiv.style.display === "block") ? "none" : "block";
    }

    function updateAllStats() {
        const div = document.getElementById('warehouse-list');
        div.innerHTML = '<strong style="display:block; margin:10px 0; color:#ff4757;">KHO ƒê√É C·∫ÆM:</strong>';
        warehouses.forEach(w => {
            const inRange = dealers.filter(d => w.latlng.distanceTo(d.latlng) <= 3000);
            const sumSales = inRange.reduce((s, d) => s + d.ds, 0);
            const rows = inRange.sort((a,b) => b.ds - a.ds).map(d => `
                <div class="dealer-row">
                    <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${d.ten}</span>
                    <span class="sales-tag">${d.ds.toLocaleString()}</span>
                    <span class="dist-tag">${(w.latlng.distanceTo(d.latlng)/1000).toFixed(1)}km</span>
                </div>`).join('');
            div.innerHTML += `
                <div class="stats-box">
                    <div onclick="toggleDealerList(${w.id})" style="cursor:pointer; font-weight:bold; display:flex; justify-content:space-between;">
                        ${w.name} (3km) <span>‚ñº</span>
                    </div>
                    <div style="font-size:12px; margin-top:5px;">KH: ${inRange.length} | T·ªïng DS: <b style="color:#f1c40f">${sumSales.toLocaleString()}</b></div>
                    <div class="dealer-list" id="list-${w.id}">
                        <div class="dealer-row" style="font-weight:bold; border-bottom:1px solid #777; color:#3498db;">
                            <span>T√™n</span><span>DS</span><span>Chim bay</span>
                        </div>
                        ${rows || '<div style="padding:10px;">Tr·ªëng</div>'}
                        <button style="background:#ff4757; color:white; padding:5px; margin-top:10px;" onclick="deleteWh(${w.id})">X√ìA KHO</button>
                    </div>
                </div>`;
        });
    }
</script>
</body>
</html>
