<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêi·ªÅu ph·ªëi Online V8.4 - D≈©ng Nguy·ªÖn</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; display: flex; height: 100vh; background: #1e272e; }
        #sidebar { width: 400px; padding: 15px; background: #1e272e; color: #ecf0f1; overflow-y: auto; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        #map { flex-grow: 1; }
        .card { background: #2d3436; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #485460; }
        .card-title { font-weight: bold; color: #ff4757; margin-bottom: 10px; border-bottom: 1px solid #485460; padding-bottom: 8px; font-size: 14px; }
        button { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; font-size: 15px; transition: 0.3s; }
        .btn-refresh { background: #2ecc71; color: white; }
        .btn-search { background: #3498db; color: white; }
        #zoom-info { position: absolute; bottom: 20px; left: 420px; z-index: 1000; background: rgba(0,0,0,0.85); color: #f1c40f; padding: 8px 18px; border-radius: 20px; font-weight: bold; border: 2px solid #ff4757; }
        .stats-box { background: #34495e; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 5px solid #ff4757; }
        .dealer-row { display: grid; grid-template-columns: 1fr 90px 60px; gap: 5px; padding: 6px 0; border-bottom: 1px solid #444; font-size: 12px; }
        .sales-tag { color: #f1c40f; text-align: right; font-weight: bold; }
        .leaflet-heatmap-layer { pointer-events: none !important; }
        .leaflet-marker-pane { z-index: 650 !important; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color: #ff4757; text-align: center; margin-bottom: 20px;">ƒêI·ªÄU PH·ªêI V8.4</h2>
    <div class="card">
        <div class="card-title">üîÑ D·ªÆ LI·ªÜU TR·ª∞C TUY·∫æN</div>
        <button class="btn-refresh" onclick="loadDataOnline()">L√ÄM M·ªöI D·ªÆ LI·ªÜU</button>
        <p id="data-status" style="font-size: 11px; color: #2ecc71; margin-top: 8px; text-align: center;">ƒêang s·∫µn s√†ng...</p>
    </div>
    <div class="card">
        <div class="card-title">üîç T√åM KHU V·ª∞C</div>
        <input type="text" id="areaSearchInput" style="width:100%; padding:10px; border-radius:5px;" placeholder="Vd: H√† N·ªôi">
        <button class="btn-search" onclick="searchArea()">Xem ranh gi·ªõi</button>
    </div>
    <div class="card">
        <div class="card-title">üìç C·∫ÆM KHO ƒê·ªÄ XU·∫§T</div>
        <select id="pinToggle" style="width:100%; padding:10px; border-radius:5px;"><option value="off">T·∫ÆT</option><option value="on">B·∫¨T</option></select>
    </div>
    <div id="warehouse-list"></div>
</div>

<div id="map"></div>
<div id="zoom-info">ZOOM: <span id="zoom-level">12</span></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    const map = L.map('map', { tap: true, zoomSnap: 0.1 }).setView([21.02, 105.83], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    let dealers = [], warehouses = [], highlightLayer = L.layerGroup().addTo(map), 
        heatLayerGroup = L.layerGroup().addTo(map), dealerLayer = L.layerGroup().addTo(map), heatLayer = null;

    async function loadDataOnline() {
        const status = document.getElementById('data-status');
        status.innerText = "ƒêang t·∫£i d·ªØ li·ªáu...";
        
        // S·ª¨ D·ª§NG LINK CHU·∫®N T·ª™ ·∫¢NH C·ª¶A D≈®NG
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSqx48yei68qBJFSiHZzxCeGO0df4IDE6md9hzu7TUv5GjgOvU9yIpm4lEN6HJw9zJuek4YYMj8XAyn/pub?gid=0&single=true&output=csv";
        
        try {
            const resp = await fetch(sheetUrl);
            const text = await resp.text();
            const rows = text.split(/\r?\n/).slice(1);
            
            dealers = []; dealerLayer.clearLayers();
            let heatPoints = [];

            rows.forEach(line => {
                const col = line.split(/,|\t/);
                if (col.length < 6) return;

                // X·ª¨ L√ù L√ÄM S·∫†CH D·∫§U CH·∫§M TRONG DOANH S·ªê
                let rawSales = col[5].toString().replace(/\./g, '').replace(/,/g, '').trim();
                const ds = parseFloat(rawSales) || 0;
                
                const lat = parseFloat(col[4]);
                const lng = parseFloat(col[3]);

                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.circleMarker([lat, lng], { 
                        radius: 5, color: '#2d3436', weight: 1, fillOpacity: 0.8, 
                        fillColor: ds > 0 ? '#ff4757' : '#95a5a6', interactive: true 
                    }).addTo(dealerLayer);
                    marker.bindTooltip(`<b>${col[1]}</b><br>DS: ${ds.toLocaleString()}`, { sticky: true });
                    dealers.push({ latlng: L.latLng(lat, lng), ds, ten: col[1], ma: col[0] });

                    if (ds > 0) {
                        let intensity = 0.4 + (ds / 500000000) * 0.4;
                        heatPoints.push([lat, lng, Math.min(intensity, 1.2)]);
                    }
                }
            });

            if (heatLayer) heatLayerGroup.removeLayer(heatLayer);
            heatLayer = L.heatLayer(heatPoints, { 
                radius: 95, blur: 30, max: 1.0, 
                gradient: { 0.2: '#ff9f43', 0.5: '#ff4757', 0.8: '#b33939', 1.0: '#5e0000' } 
            }).addTo(heatLayerGroup);
            
            status.innerText = "C·∫≠p nh·∫≠t th√†nh c√¥ng!";
            updateZoom();
        } catch (e) { 
            status.innerText = "L·ªói k·∫øt n·ªëi!";
            alert("Vui l√≤ng ch·∫°y link t·ª´ GitHub (HTTPS) ƒë·ªÉ tr√°nh l·ªói b·∫£o m·∫≠t!"); 
        }
    }

    window.onload = loadDataOnline;

    function updateZoom() {
        const z = map.getZoom(); document.getElementById('zoom-level').innerText = z.toFixed(1);
        if (heatLayer) {
            let r = (z >= 13) ? 100 : (z >= 11 ? 80 : 60);
            heatLayer.setOptions({ radius: r });
        }
    }
    map.on('zoomend', updateZoom);

    async function searchArea() {
        const input = document.getElementById('areaSearchInput').value;
        if (!input) return;
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(input + ", Vietnam")}&format=json&polygon_geojson=1&limit=1`);
        const data = await resp.json();
        if (data.length > 0) {
            highlightLayer.clearLayers();
            const g = L.geoJSON(data[0].geojson, { style: { color: "#3498db", weight: 3, fillOpacity: 0 } }).addTo(highlightLayer);
            map.fitBounds(g.getBounds());
        }
    }

    map.on('click', e => {
        if (document.getElementById('pinToggle').value !== 'on') return;
        const marker = L.marker(e.latlng, { draggable: true }).addTo(map);
        const circle = L.circle(e.latlng, { radius: 3000, color: '#ff4757', fillOpacity: 0.1 }).addTo(map);
        const id = Date.now();
        const wh = { id, marker, circle, latlng: e.latlng, name: "Kho " + (warehouses.length + 1) };
        marker.on('contextmenu', () => { map.removeLayer(marker); map.removeLayer(circle); warehouses = warehouses.filter(x => x.id !== id); updateStats(); });
        marker.on('dragend', () => { wh.latlng = marker.getLatLng(); circle.setLatLng(wh.latlng); updateStats(); });
        warehouses.push(wh); updateStats();
    });

    function updateStats() {
        const d = document.getElementById('warehouse-list');
        d.innerHTML = '<strong style="color:#ff4757; display:block; margin:10px 0;">KHO ƒê√É C·∫ÆM:</strong>';
        warehouses.forEach(w => {
            const inR = dealers.filter(x => w.latlng.distanceTo(x.latlng) <= 3000);
            const sum = inR.reduce((a, b) => a + b.ds, 0);
            d.innerHTML += `<div class="stats-box"><b>${w.name} (3km)</b><br>KH: ${inR.length} | DS: ${sum.toLocaleString()}</div>`;
        });
    }
</script>
</body>
</html>
