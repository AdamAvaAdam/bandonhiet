<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng ƒêi·ªÅu ph·ªëi B·∫£o m·∫≠t V9.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #1e272e; }
        
        /* M√ÄN H√åNH ƒêƒÇNG NH·∫¨P */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1e272e; display: flex; align-items: center; justify-content: center;
            z-index: 9999; transition: 0.5s;
        }
        .login-box {
            background: #2d3436; padding: 30px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 320px; text-align: center;
            border: 1px solid #ff4757;
        }
        .login-box h2 { color: #ff4757; margin-bottom: 20px; }
        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 6px;
            border: 1px solid #485460; background: #1e272e; color: white; box-sizing: border-box;
        }
        .login-box button {
            width: 100%; padding: 12px; background: #ff4757; color: white;
            border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
        }

        /* GIAO DI·ªÜN CH√çNH (·∫®N KHI CH∆ØA LOGIN) */
        #main-app { display: none; height: 100vh; width: 100%; flex-direction: row; }
        #sidebar { width: 400px; padding: 15px; background: #1e272e; color: #ecf0f1; overflow-y: auto; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        #map { flex-grow: 1; }
        .card { background: #2d3436; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #485460; }
        .card-title { font-weight: bold; color: #ff4757; margin-bottom: 10px; border-bottom: 1px solid #485460; padding-bottom: 8px; font-size: 14px; }
        select, input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; border-radius: 6px; border: none; background: #ecf0f1; color: #2d3436; font-size: 16px; box-sizing: border-box; }
        .btn-refresh { background: #2ecc71; color: white; width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px;}
        #zoom-info { position: absolute; bottom: 20px; left: 420px; z-index: 1000; background: rgba(0,0,0,0.85); color: #f1c40f; padding: 8px 18px; border-radius: 20px; font-weight: bold; border: 2px solid #ff4757; pointer-events: none; }
        .stats-box { background: #34495e; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 5px solid #ff4757; }
        .leaflet-heatmap-layer, .leaflet-interactivePath { pointer-events: none !important; }
        .leaflet-marker-pane { z-index: 650 !important; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>ƒêƒÇNG NH·∫¨P H·ªÜ TH·ªêNG</h2>
        <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
        <button onclick="checkLogin()">V√ÄO B·∫¢N ƒê·ªí</button>
        <p id="login-error" style="color: #ff4757; font-size: 12px; margin-top: 10px; display: none;">Sai th√¥ng tin ƒëƒÉng nh·∫≠p!</p>
    </div>
</div>

<div id="main-app">
    <div id="sidebar">
        <h2 style="color: #ff4757; text-align: center; margin-bottom: 20px;">ƒêI·ªÄU PH·ªêI V9.0</h2>
        <div class="card">
            <div class="card-title">üîÑ D·ªÆ LI·ªÜU & HI·ªÇN TH·ªä</div>
            <button class="btn-refresh" onclick="loadDataOnline()">L√ÄM M·ªöI T·ª™ SHEETS</button>
            <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                <span>ƒêi·ªÉm ƒë·∫°i l√Ω:</span>
                <select id="pointToggle" onchange="togglePointLayer()" style="width:100px;"><option value="on">B·∫¨T</option><option value="off">T·∫ÆT</option></select>
            </div>
            <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                <span>Qu·∫ßng nhi·ªát:</span>
                <select id="heatToggle" onchange="toggleHeatLayer()" style="width:100px;"><option value="on">B·∫¨T</option><option value="off">T·∫ÆT</option></select>
            </div>
        </div>
        <div class="card">
            <div class="card-title">üìç KHO ƒê·ªÄ XU·∫§T</div>
            <select id="pinToggle" style="width:100%; padding:10px;"><option value="off">T·∫ÆT C·∫ÆM GHIM</option><option value="on">B·∫¨T C·∫ÆM GHIM</option></select>
        </div>
        <div id="warehouse-list"></div>
    </div>
    <div id="map"></div>
    <div id="zoom-info">ZOOM: <span id="zoom-level">12</span></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    // --- C·∫§U H√åNH ƒêƒÇNG NH·∫¨P ---
    function checkLogin() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        
        // D≈©ng c√≥ th·ªÉ ƒë·ªïi 'admin' v√† '123456' th√†nh t√™n b·∫°n mu·ªën
        if (user === 'admin' && pass === '123456') {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            map.invalidateSize(); // Reset l·∫°i b·∫£n ƒë·ªì sau khi hi·ªán
            loadDataOnline(); // T·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng
        } else {
            document.getElementById('login-error').style.display = 'block';
        }
    }

    // --- KH·ªûI T·∫†O B·∫¢N ƒê·ªí ---
    const map = L.map('map', { tap: true, zoomSnap: 0.1 }).setView([21.02, 105.83], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    let dealers = [], warehouses = [], heatLayerGroup = L.layerGroup().addTo(map), 
        dealerLayer = L.layerGroup().addTo(map), heatLayer = null;

    async function loadDataOnline() {
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSqx48yei68qBJFSiHZzxCeGO0df4IDE6md9hzu7TUv5GjgOvU9yIpm4lEN6HJw9zJuek4YYMj8XAyn/pub?gid=0&single=true&output=csv";
        try {
            const resp = await fetch(sheetUrl);
            const text = await resp.text();
            const rows = text.split(/\r?\n/).slice(1);
            dealers = []; dealerLayer.clearLayers();
            let heatPoints = [];

            rows.forEach(line => {
                const col = line.split(/,|\t/);
                if (col.length < 6) return;
                let ds = parseFloat(col[5].toString().replace(/\./g, '').replace(/,/g, '')) || 0;
                let lat = parseFloat(col[4].toString().replace(',', '.'));
                let lng = parseFloat(col[3].toString().replace(',', '.'));

                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.circleMarker([lat, lng], { radius: 5, color: '#2d3436', weight: 1, fillOpacity: 0.8, fillColor: ds > 0 ? '#ff4757' : '#95a5a6', interactive: true });
                    marker.bindTooltip(`<b>${col[1]}</b><br>DS: ${ds.toLocaleString()}`, { sticky: true });
                    dealers.push({ latlng: L.latLng(lat, lng), ds, ten: col[1], marker: marker });
                    if (document.getElementById('pointToggle').value === 'on') marker.addTo(dealerLayer);
                    if (ds > 0) heatPoints.push([lat, lng, Math.min(0.4 + (ds / 500000000) * 0.4, 1.2)]);
                }
            });

            if (heatLayer) heatLayerGroup.removeLayer(heatLayer);
            heatLayer = L.heatLayer(heatPoints, { radius: 95, blur: 30, max: 1.0, gradient: { 0.2: '#ff9f43', 0.5: '#ff4757', 0.8: '#b33939', 1.0: '#5e0000' } });
            if (document.getElementById('heatToggle').value === 'on') heatLayer.addTo(heatLayerGroup);
        } catch (e) { console.log("L·ªói t·∫£i d·ªØ li·ªáu"); }
    }

    function togglePointLayer() {
        dealerLayer.clearLayers();
        if (document.getElementById('pointToggle').value === 'on') dealers.forEach(d => d.marker.addTo(dealerLayer));
    }

    function toggleHeatLayer() {
        if (!heatLayer) return;
        document.getElementById('heatToggle').value === 'on' ? heatLayer.addTo(heatLayerGroup) : heatLayerGroup.removeLayer(heatLayer);
    }

    map.on('zoomend', () => {
        const z = map.getZoom(); document.getElementById('zoom-level').innerText = z.toFixed(1);
        if (heatLayer) heatLayer.setOptions({ radius: (z >= 13) ? 105 : (z >= 11 ? 85 : 60) });
    });

    map.on('click', e => {
        if (document.getElementById('pinToggle').value !== 'on') return;
        const marker = L.marker(e.latlng, { draggable: true }).addTo(map);
        const circle = L.circle(e.latlng, { radius: 3000, color: '#ff4757', fillOpacity: 0.1 }).addTo(map);
        const id = Date.now();
        const wh = { id, marker, circle, latlng: e.latlng, name: "Kho " + (warehouses.length + 1) };
        marker.on('contextmenu', () => { map.removeLayer(marker); map.removeLayer(circle); warehouses = warehouses.filter(x => x.id !== id); updateStats(); });
        marker.on('dragend', () => { wh.latlng = marker.getLatLng(); circle.setLatLng(wh.latlng); updateStats(); });
        warehouses.push(wh); updateStats();
    });

    function updateStats() {
        const d = document.getElementById('warehouse-list');
        d.innerHTML = '<strong style="color:#ff4757; display:block; margin:10px 0;">KHO ƒê√É C·∫ÆM:</strong>';
        warehouses.forEach(w => {
            const inR = dealers.filter(x => w.latlng.distanceTo(x.latlng) <= 3000);
            const sum = inR.reduce((a, b) => a + b.ds, 0);
            d.innerHTML += `<div class="stats-box"><b>${w.name} (3km)</b><br>KH: ${inR.length} | DS: ${sum.toLocaleString()}</div>`;
        });
    }
</script>
</body>
</html>
